<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Angelo's Burger POS</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/user-settings.css">    
</head>
<body>
    
    <div class="sidebar">
        <div class="logo-section">
            <div class="logo-title">Angelo's</div>
            <div class="logo-subtitle">Burger</div>
        </div>

        <div class="menu-top">
            <div class="menu-item">
                <a href="/Dashboard/Admin-dashboard">Dashboard</a></div>
            <div class="menu-item"> 
            <a href="/Dashboard/Admin-dashboard/Inventory">Inventory</a>
            </div>
            <div class="menu-item"> 
            <a href="/Dashboard/User-dashboard/Inventory/Reports">Reports</a>
            </div>
        </div>

            <div class="menu-item active">
                <a href="/Dashboard/User-dashboard/user-settings">Settings</a>
            </div>

        <div class="logout-section">
            <button class="logout-btn">Logout</button>
        </div>
    </div>
    
    <div class="main-content">
        <h3 class="Settings" style="color: #6a0dad;">Settings</h3>
        <div class="content-box7">
            <!-- Pagination Buttons -->
            <div class="pagination-buttons">
                <button class="page-btn active" data-page="accounts">Accounts</button>
                <button class="page-btn" data-page="hash">#</button>
            </div>
            
            <div class="pagination-info">
                Currently viewing: Accounts
            </div>
        </div>
        <br>
        <div class="content-box">
            <br>
            <!-- Accounts content-box -->
            <div class="content-box-content active" id="account-box-content">
                <h4 style="color: #6a0dad; margin-bottom: 20px;">Accounts</h4>
                <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <p style="color: #666; margin-bottom: 15px;"></p>
                
                </div>
            </div>
            
            <!-- # content-box -->
            <div class="content-box-content" id="hash-box-content">
                <h4 style="color: #6a0dad; margin-bottom: 20px;">#</h4>
                <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <p style="color: #666; margin-bottom: 15px;"></p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
    <script>
        // Menu item active state
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function () {
                document.querySelectorAll('.menu-item').forEach(i => {
                    i.classList.remove('active');
                });
                this.classList.add('active');
            });
        });

       // ================= LOGOUT FUNCTIONALITY =================
        document.querySelector('.logout-btn').addEventListener('click', function() {
            if (confirm('Are you sure you want to logout?')) {
                performLogout();
            }
        });


        async function performLogout() {

            try {
 
                const logoutBtn = document.querySelector('.logout-btn');
                const originalText = logoutBtn.textContent;
                logoutBtn.textContent = 'Logging out...';
                logoutBtn.disabled = true;

                try {
                    await fetch('/api/auth/logout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                        }
                    });
                } catch (apiError) {
                    console.log('Backend logout not available');
                }


                const posOrderCounter = localStorage.getItem('posOrderCounter');
                localStorage.clear();
                
                
                if (posOrderCounter) {
                    localStorage.setItem('posOrderCounter', posOrderCounter);
                }


                sessionStorage.clear();


                document.cookie.split(";").forEach(function(c) {
                    const cookieName = c.split("=")[0].trim();

                    if (cookieName.includes('auth') || cookieName.includes('token') || cookieName.includes('session')) {
                        document.cookie = cookieName + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                    }
                });


                if (eventSource) {
                    eventSource.close();
                }


                showNotification('Successfully logged out!');


                setTimeout(() => {
                    window.location.replace('/');
                }, 1000);

            } catch (error) {
                console.error('Logout error:', error);
                
                const posOrderCounter = localStorage.getItem('posOrderCounter');
                localStorage.clear();
                if (posOrderCounter) {
                    localStorage.setItem('posOrderCounter', posOrderCounter);
                }
                window.location.replace('/');
            }
        }

        // ================= AUTHENTICATION CHECK =================
        // Checks user if Authenticated
        function checkAuthentication() {
            const isAuthenticated = localStorage.getItem('isAuthenticated');
            
            // If not Authenticated, redirect to login page
            if (!isAuthenticated || isAuthenticated !== 'true') {
                window.location.replace('/');
                return false;
            }
            
            
            if (!localStorage.getItem('loginTime')) {
                localStorage.setItem('loginTime', Date.now().toString());
            }
            
            return true;
        }

        // ================= SESSION MANAGEMENT =================
        // Session expirs every 5 mins
        let sessionCheckInterval = null;

        function startSessionTimer() {

            if (sessionCheckInterval) {
                clearInterval(sessionCheckInterval);
            }
            
            // Checks session every 5 mins
            sessionCheckInterval = setInterval(() => {
                const loginTime = localStorage.getItem('loginTime');
                if (loginTime) {
                    const currentTime = Date.now();
                    const sessionAge = currentTime - parseInt(loginTime);
                    const maxSessionAge = 8 * 60 * 60 * 1000; // this is 8 hours
                    
                    if (sessionAge > maxSessionAge) {
                        clearInterval(sessionCheckInterval);
                        performLogout();
                    }
                }
            }, 300000); // this is 5 minutes
        }


        function resetSessionTimer() {
            // Updates login time
            localStorage.setItem('loginTime', Date.now().toString());
            
            // Restarts the session check interval
            startSessionTimer();
        }


        function setupActivityDetection() {
        
            ['click', 'mousemove', 'keydown', 'scroll', 'touchstart'].forEach(event => {
                document.addEventListener(event, resetSessionTimer, { passive: true });
            });
        }

        // ================= PAGE NAVIGATION =================
        
        document.addEventListener('click', function(e) {
        
            if (e.target.closest('.menu-item a')) {
                const link = e.target.closest('.menu-item a');
                const href = link.getAttribute('href');
                

                localStorage.setItem('loginTime', Date.now().toString());
              
            }
        });

        // ================= INITIALIZATION =================
        function initDashboard() {
            
            if (!checkAuthentication()) {
                return;
            }
            

            if (!localStorage.getItem('loginTime')) {
                localStorage.setItem('loginTime', Date.now().toString());
            }
            

            startSessionTimer();
            

            setupActivityDetection();
            

            loadDashboardData();
            initRealtimeUpdates();
       
        }


        document.addEventListener('DOMContentLoaded', initDashboard);

        // ================= END OF LOGOUT FUNCTIONALITY =================
        // Pagination functionality
        document.querySelectorAll('.page-btn').forEach(button => {
            button.addEventListener('click', function() {
                const pageId = this.getAttribute('data-page');
                

                document.querySelectorAll('.page-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                this.classList.add('active');
                
                document.querySelectorAll('.content-box-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                document.getElementById(`${pageId}-box-content`).classList.add('active');
                
                const infoDiv = document.querySelector('.pagination-info');
                if (pageId === 'account') {
                    infoDiv.textContent = 'Currently viewing: Accounts';
                } else if (pageId === 'hash') {
                    infoDiv.textContent = 'Currently viewing: #';
                }
            });
        });
    </script>

</body>
</html>